name: Gemini Code Review

on:
    pull_request:        # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚ã€ã¾ãŸã¯æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
        types: [opened, synchronize]

jobs:
    review:
        runs-on: ubuntu-latest
        permissions:
            contents: read       # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿å–ã‚‹æ¨©é™
            pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€æ¨©é™

        steps:
            - name: Checkout code
              uses: actions/checkout@v4  # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              with:
                  fetch-depth: 0         # å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—

            - name: Get changed files
              id: changed_files
              run: |
                  # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
                  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ™ãƒ¼ã‚¹ã¨ãƒ˜ãƒƒãƒ‰ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
                  echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
                  echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
                  echo "::set-output name=files::$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(js|py|java|ts|go|rb|php|cs|cpp|c|swift|kt|m|html|css|scss)$' | xargs)"  # å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

            - name: Setup Python
              if: steps.changed_files.outputs.files  # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            - name: Install dependencies
              if: steps.changed_files.outputs.files
              run: pip install requests

            - name: Run Gemini Code Review
              if: steps.changed_files.outputs.files
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  CHANGED_FILES: ${{ steps.changed_files.outputs.files }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ä½¿ç”¨
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  REPO_OWNER: ${{ github.repository_owner }}
                  REPO_NAME: ${{ github.event.repository.name }}
              run: |
                  # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã“ã“ã«ç›´æ¥æ›¸ãã‹ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦å‘¼ã³å‡ºã™
                  # (ä¾‹: python .github/scripts/review_code.py)
                  # ä»¥ä¸‹ã¯Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
                  cat << 'EOF' > .github/scripts/review_code.py
                  import os
                  import requests
                  import json

                  GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
                  CHANGED_FILES = os.environ.get("CHANGED_FILES", "").split()
                  GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN")
                  PR_NUMBER = os.environ.get("PR_NUMBER")
                  REPO_OWNER = os.environ.get("REPO_OWNER")
                  REPO_NAME = os.environ.get("REPO_NAME")

                  # Gemini API (Generative Language API) ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¾‹
                  # æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç¢ºèªã—ã¦ãã ã•ã„
                  # Gemini 1.5 Flash ã®ä¾‹
                  API_URL = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key={GEMINI_API_KEY}"
                  # Gemini 1.5 Pro ã‚’ä½¿ã„ãŸã„å ´åˆã¯ãƒ¢ãƒ‡ãƒ«åã‚’å¤‰æ›´
                  # API_URL = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key={GEMINI_API_KEY}"


                  headers = {"Content-Type": "application/json"}
                  github_comments_url = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/issues/{PR_NUMBER}/comments"
                  github_headers = {
                      "Authorization": f"token {GITHUB_TOKEN}",
                      "Accept": "application/vnd.github.v3+json"
                  }

                  if not CHANGED_FILES:
                      print("No relevant files changed for review.")
                      exit()

                  all_reviews = "## âœ¨ Gemini Pro ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ âœ¨\n\n"

                  for file_path in CHANGED_FILES:
                      try:
                          with open(file_path, 'r', encoding='utf-8') as f:
                              code_content = f.read()

                          if not code_content.strip():
                              print(f"Skipping empty file: {file_path}")
                              continue

                          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å·¥å¤«ãŒé‡è¦
                          prompt = f\"\"\"ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Unityã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
                          ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€æ½œåœ¨çš„ãªãƒã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ã€å¯èª­æ€§ã‚„ä¿å®ˆæ€§ã®æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
                          å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚‚ã‚ã‚Œã°æç¤ºã—ã¦ãã ã•ã„ã€‚
                          ãƒ•ã‚¡ã‚¤ãƒ«å: {file_path}
                          ---ã‚³ãƒ¼ãƒ‰---
                          {code_content}
                          ---ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹---
                          - ãƒã‚°ã®å¯èƒ½æ€§
                          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
                          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
                          - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„é•åï¼ˆä¸€èˆ¬çš„ãªãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ãï¼‰
                          - å¯èª­æ€§ã®ä½ã„ç®‡æ‰€
                          - å†—é•·ãªã‚³ãƒ¼ãƒ‰
                          - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸è¶³
                          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                          - ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§
                          ---å‡ºåŠ›å½¢å¼---
                          å•é¡Œç‚¹ã€æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£ã€ç†ç”±ã‚’Markdownå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
                          ã‚‚ã—å•é¡ŒãŒãªã‘ã‚Œã°ã€Œç‰¹ã«å¤§ããªå•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã€ã¨è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
                          \"\"\"

                          data = {
                              "contents": [{"parts": [{"text": prompt}]}],
                              "generationConfig": {
                                  "temperature": 0.3,
                                  "maxOutputTokens": 4096
                              },
                              "safetySettings": [
                                  {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                                  {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                                  {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                                  {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"}
                              ]
                          }

                          print(f"Requesting review for {file_path}...")
                          response = requests.post(API_URL, headers=headers, json=data, timeout=180)
                          response.raise_for_status()
                          review_result = response.json()

                          if 'candidates' in review_result and review_result['candidates']:
                              if 'content' in review_result['candidates'][0] and 'parts' in review_result['candidates'][0]['content']:
                                  review_text = review_result['candidates'][0]['content']['parts'][0]['text']
                                  all_reviews += f"\n### ğŸ“„ `{file_path}`\n\n{review_text}\n\n---\n"
                              else:
                                  all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n---\n"
                          elif 'promptFeedback' in review_result:
                              all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«é–¢ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚Šã¾ã—ãŸ: {review_result['promptFeedback']}\n\n---\n"
                          else:
                              all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\n---\n"

                      except requests.exceptions.RequestException as e:
                          all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (RequestException): {e}\n\n---\n"
                          print(f"Error reviewing {file_path}: {e}")
                      except FileNotFoundError:
                          all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\n---\n"
                          print(f"File not found: {file_path}")
                      except Exception as e:
                          all_reviews += f"\n### ğŸ“„ `{file_path}`\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}\n\n---\n"
                          print(f"Unexpected error reviewing {file_path}: {e}")


                  if all_reviews.strip() != "## âœ¨ Gemini Pro ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ âœ¨":
                      comment_data = {"body": all_reviews}
                      response = requests.post(github_comments_url, headers=github_headers, json=comment_data)
                      if response.status_code == 201:
                          print("Successfully posted review comments to PR.")
                      else:
                          print(f"Failed to post comments to PR: {response.status_code} - {response.text}")
                  else:
                      print("No review comments to post.")
                  EOF
                  python .github/scripts/review_code.py